<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ç©å®¶æµè§ˆå™¨ - æ¼è›‹è®¡åˆ†å™¨</title>
<meta name="theme-color" content="#0b0b0c">
<link rel="stylesheet" href="/src/style.css">
<style>
  /* Modern Tab Navigation */
  .nav-tabs {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
    padding: 6px;
    background: #1a1a1a;
    border-radius: 12px;
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
  }
  
  .nav-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
  }
  
  .nav-tab:not(.active) {
    color: #888;
    background: transparent;
  }
  
  .nav-tab:not(.active):hover {
    color: #fff;
    background: #252525;
  }
  
  .nav-tab.active {
    color: #fff;
    background: #3b82f6;
  }
  
  .nav-tab-icon {
    font-size: 18px;
  }

  .player-card {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: pointer;
  }
  .player-card:hover {
    background: #252525;
    border-color: #444;
    transform: translateY(-2px);
  }
  .player-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  .stat-badge {
    display: inline-block;
    background: #2a2a2a;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    margin: 2px;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ‘¥ ç©å®¶æµè§ˆå™¨</h1>

  <!-- Modern Navigation Tabs -->
  <div class="nav-tabs">
    <a href="/players.html" class="nav-tab active">
      <span class="nav-tab-icon">ğŸ‘¥</span>
      <span>æµè§ˆç©å®¶</span>
    </a>
    <a href="/rooms.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ </span>
      <span>æµè§ˆæˆ¿é—´</span>
    </a>
    <a href="/" class="nav-tab">
      <span class="nav-tab-icon">ğŸ®</span>
      <span>æ¸¸æˆ</span>
    </a>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom: 16px;">
      <input
        type="text"
        id="searchInput"
        placeholder="æœç´¢ç”¨æˆ·åæˆ–æ˜µç§°..."
        style="flex: 1; padding: 12px; background: #0b0b0c; border: 1px solid #333; border-radius: 6px; margin-right: 8px;"
      />
      <button id="searchButton" style="padding: 12px 24px; background: #3b82f6; color: white;">æœç´¢</button>
      <button id="createPlayerButton" style="padding: 12px 24px; background: #22c55e; color: white; margin-left: 8px;">åˆ›å»ºæ–°ç©å®¶</button>
      <button id="adminModeButton" style="padding: 12px 24px; background: #ef4444; color: white; margin-left: 8px;">ğŸ”’ ç®¡ç†æ¨¡å¼</button>
    </div>

    <!-- Admin token input (hidden by default) -->
    <div id="adminTokenContainer" style="margin-bottom: 16px; display: none;">
      <div style="background: #2a1a1a; border: 1px solid #ef4444; padding: 12px; border-radius: 6px;">
        <label style="display: block; margin-bottom: 6px; color: #ef4444; font-weight: bold;">âš ï¸ ç®¡ç†å‘˜å¯†ç </label>
        <input
          type="password"
          id="adminTokenInput"
          placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ..."
          style="width: 100%; padding: 8px 12px; background: #0b0b0c; border: 1px solid #ef4444; border-radius: 6px; color: white;"
        />
        <div style="color: #888; font-size: 0.85em; margin-top: 6px;">
          ç®¡ç†æ¨¡å¼å¯ä»¥åˆ é™¤ç©å®¶æˆ–é‡ç½®ç»Ÿè®¡æ•°æ®
        </div>
      </div>
    </div>

    <div style="color: #888; font-size: 0.9em; margin-bottom: 16px;">
      <span id="playerCount">åŠ è½½ä¸­...</span>
    </div>

    <div id="playersList" class="player-grid">
      <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">
        åŠ è½½ä¸­...
      </div>
    </div>

    <div id="pagination" style="margin-top: 20px; text-align: center; display: none;">
      <button id="prevPage" style="margin-right: 8px;" disabled>â† ä¸Šä¸€é¡µ</button>
      <span id="pageInfo" style="color: #888; margin: 0 16px;"></span>
      <button id="nextPage" disabled>ä¸‹ä¸€é¡µ â†’</button>
    </div>
  </div>
</div>

<script type="module">
import { searchPlayers, getPlayStyleLabel } from '/src/api/playerApi.js';
import { initializeCreateModal, showCreateModal } from '/src/player/playerCreateModal.js';
import { renderProfileAvatar } from '/src/player/photoRenderer.js';

let currentPage = 0;
const pageSize = 20;
let allPlayers = [];
let filteredPlayers = [];
let isAdminMode = false;
let adminToken = '';

// Initialize create modal
initializeCreateModal((createdPlayer) => {
  console.log('Player created:', createdPlayer);
  // Reload players list
  loadPlayers();
});

// Admin mode toggle
const adminModeButton = document.getElementById('adminModeButton');
const adminTokenContainer = document.getElementById('adminTokenContainer');
const adminTokenInput = document.getElementById('adminTokenInput');

if (adminModeButton) {
  adminModeButton.addEventListener('click', () => {
    isAdminMode = !isAdminMode;
    
    if (isAdminMode) {
      adminTokenContainer.style.display = 'block';
      adminModeButton.textContent = 'ğŸ”“ é€€å‡ºç®¡ç†';
      adminModeButton.style.background = '#f59e0b';
    } else {
      adminTokenContainer.style.display = 'none';
      adminModeButton.textContent = 'ğŸ”’ ç®¡ç†æ¨¡å¼';
      adminModeButton.style.background = '#ef4444';
      adminToken = '';
      if (adminTokenInput) adminTokenInput.value = '';
    }
    
    // Re-render players to show/hide admin buttons
    renderPlayers();
  });
}

if (adminTokenInput) {
  adminTokenInput.addEventListener('input', (e) => {
    adminToken = e.target.value;
    
    // Visual feedback for correct password
    const container = document.getElementById('adminTokenContainer');
    const containerInner = container?.querySelector('div');
    
    if (adminToken === 'xiaofei0214') {
      if (containerInner) {
        containerInner.style.borderColor = '#22c55e';
        containerInner.style.background = '#1a2e1a';
      }
      adminTokenInput.style.borderColor = '#22c55e';
      
      // Show success message
      let successMsg = container?.querySelector('.admin-success-msg');
      if (!successMsg) {
        successMsg = document.createElement('div');
        successMsg.className = 'admin-success-msg';
        successMsg.style.cssText = 'color: #22c55e; font-size: 0.85em; margin-top: 6px; font-weight: bold;';
        successMsg.textContent = 'âœ“ ç®¡ç†å‘˜æƒé™å·²æ¿€æ´»';
        containerInner?.appendChild(successMsg);
      }
      
      // Re-render to show admin buttons
      renderPlayers();
    } else {
      if (containerInner) {
        containerInner.style.borderColor = '#ef4444';
        containerInner.style.background = '#2a1a1a';
      }
      adminTokenInput.style.borderColor = '#ef4444';
      
      // Remove success message
      const successMsg = container?.querySelector('.admin-success-msg');
      if (successMsg) {
        successMsg.remove();
      }
    }
  });
}

async function loadPlayers(query = '') {
  try {
    const result = await searchPlayers(query, 100);
    allPlayers = result.players;
    filteredPlayers = allPlayers;

    document.getElementById('playerCount').textContent =
      `å…± ${result.total} ä½ç©å®¶${query ? ` (åŒ¹é… "${query}")` : ''}`;

    currentPage = 0;
    renderPlayers();
  } catch (error) {
    console.error('Failed to load players:', error);
    document.getElementById('playersList').innerHTML =
      '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
  }
}

function renderPlayers() {
  const container = document.getElementById('playersList');
  const start = currentPage * pageSize;
  const end = start + pageSize;
  const playersToShow = filteredPlayers.slice(start, end);

  if (playersToShow.length === 0) {
    container.innerHTML =
      '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">æš‚æ— ç©å®¶</div>';
    return;
  }

  container.innerHTML = playersToShow.map(player => `
    <div class="player-card" onclick="location.href='/player-profile.html?handle=${player.handle}'">
      <div style="display: flex; align-items: center; margin-bottom: 12px;">
        ${renderProfileAvatar(player, 64)}
        <div style="flex: 1;">
          <h3 style="margin: 0 0 4px 0; font-size: 24px;">${player.displayName}</h3>
          <div style="color: #888; font-size: 0.9em;">@${player.handle}</div>
        </div>
      </div>

      <div style="color: #888; margin-bottom: 8px; font-size: 0.9em;">
        ${getPlayStyleLabel(player.playStyle)}
      </div>

      <div style="font-style: italic; color: #fbbf24; margin-bottom: 12px; font-size: 0.95em;">
        "${player.tagline}"
      </div>

      <div>
        <span class="stat-badge">ğŸ® ${player.stats.sessionsPlayed || player.stats.gamesPlayed || 0} åœº</span>
        <span class="stat-badge">ğŸ† ${player.stats.sessionsWon || player.stats.wins || 0} èƒœ</span>
        <span class="stat-badge">ğŸ“Š èƒœç‡ ${((player.stats.sessionWinRate || player.stats.winRate || 0) * 100).toFixed(1)}%</span>
        <span class="stat-badge">ğŸ“ˆ åœºå‡ ${(player.stats.avgRankingPerSession || player.stats.avgRanking || 0).toFixed(2)} å</span>
      </div>

      ${isAdminMode ? `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; display: flex; gap: 8px;">
          <button 
            onclick="event.stopPropagation(); resetPlayerStats('${player.handle}')"
            style="flex: 1; padding: 8px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
            ğŸ”„ é‡ç½®ç»Ÿè®¡
          </button>
          <button 
            onclick="event.stopPropagation(); deletePlayer('${player.handle}')"
            style="flex: 1; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
            ğŸ—‘ï¸ åˆ é™¤ç©å®¶
          </button>
        </div>
      ` : ''}
    </div>
  `).join('');

  // Update pagination
  updatePagination();
}

function updatePagination() {
  const totalPages = Math.ceil(filteredPlayers.length / pageSize);
  const pagination = document.getElementById('pagination');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const pageInfo = document.getElementById('pageInfo');

  if (totalPages <= 1) {
    pagination.style.display = 'none';
    return;
  }

  pagination.style.display = 'block';
  pageInfo.textContent = `ç¬¬ ${currentPage + 1} / ${totalPages} é¡µ`;

  prevBtn.disabled = currentPage === 0;
  nextBtn.disabled = currentPage >= totalPages - 1;
}

// Event handlers
document.getElementById('searchButton').onclick = () => {
  const query = document.getElementById('searchInput').value;
  loadPlayers(query);
};

document.getElementById('createPlayerButton').onclick = () => {
  showCreateModal();
};

document.getElementById('searchInput').onkeypress = (e) => {
  if (e.key === 'Enter') {
    const query = document.getElementById('searchInput').value;
    loadPlayers(query);
  }
};

document.getElementById('prevPage').onclick = () => {
  if (currentPage > 0) {
    currentPage--;
    renderPlayers();
  }
};

document.getElementById('nextPage').onclick = () => {
  const totalPages = Math.ceil(filteredPlayers.length / pageSize);
  if (currentPage < totalPages - 1) {
    currentPage++;
    renderPlayers();
  }
};

// Admin functions (global for onclick handlers)
window.deletePlayer = async function(handle) {
  if (!adminToken) {
    alert('è¯·å…ˆè¾“å…¥ç®¡ç†å‘˜å¯†ç ');
    return;
  }

  if (!confirm(`ç¡®å®šè¦åˆ é™¤ç©å®¶ @${handle} å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
    return;
  }

  try {
    const response = await fetch('/api/players/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ handle, adminToken })
    });

    const result = await response.json();

    if (result.success) {
      alert(`âœ… å·²åˆ é™¤ç©å®¶ @${handle}`);
      loadPlayers(); // Reload list
    } else {
      alert(`âŒ åˆ é™¤å¤±è´¥: ${result.error}`);
    }
  } catch (error) {
    console.error('Delete error:', error);
    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
};

window.resetPlayerStats = async function(handle) {
  if (!adminToken) {
    alert('è¯·å…ˆè¾“å…¥ç®¡ç†å‘˜å¯†ç ');
    return;
  }

  if (!confirm(`ç¡®å®šè¦é‡ç½® @${handle} çš„æ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿ\n\næ¸¸æˆè®°å½•ã€è£èª‰ã€æˆå°±ç­‰å°†å…¨éƒ¨æ¸…ç©ºï¼`)) {
    return;
  }

  try {
    const response = await fetch('/api/players/reset-stats', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ handle, adminToken })
    });

    const result = await response.json();

    if (result.success) {
      alert(`âœ… å·²é‡ç½® @${handle} çš„ç»Ÿè®¡æ•°æ®`);
      loadPlayers(); // Reload list
    } else {
      alert(`âŒ é‡ç½®å¤±è´¥: ${result.error}`);
    }
  } catch (error) {
    console.error('Reset error:', error);
    alert('é‡ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
};

// Load on page load
loadPlayers();
</script>
</body>
</html>
