<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>掼蛋升级计算器 v9.0</title>
<meta name="theme-color" content="#0b0b0c">
<link rel="stylesheet" href="/src/style.css">
</head>
<body>
<div class="wrap">
  <h1>掼蛋升级计算器 v9.0 <span class="badge">玩家系统</span></h1>

  <!-- 玩家设置 -->
  <div class="card">
    <h3>玩家设置</h3>
    <div class="row">
      <label for="mode">人数：</label>
      <select id="mode"><option value="4">4 人</option><option value="6">6 人</option><option value="8" selected>8 人</option></select>
      <button id="generatePlayers">生成玩家</button>
      <button id="shuffleTeams">随机分配队伍</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <label for="bulkNames">批量输入姓名：</label>
      <input type="text" id="bulkNames" placeholder="超 豪 姐 哥 帆 夫 塔 小" style="flex:1; margin-right:8px;">
      <button id="applyBulkNames">应用姓名</button>
      <button id="quickStart" style="background:#4ade80; color:white; margin-left:4px;">快速开始</button>
    </div>
    <div class="unassigned-players" id="unassignedPlayers">
      <div class="small muted" style="width:100%">点击"生成玩家"开始</div>
    </div>
    
    <div class="grid">
      <div>
        <h4 id="team1Label">蓝队</h4>
        <div class="team-drop-zone" id="team1Zone" data-team="1">
          <div class="label">拖拽玩家到这里分配队伍</div>
        </div>
      </div>
      <div>
        <h4 id="team2Label">红队</h4>
        <div class="team-drop-zone" id="team2Zone" data-team="2">
          <div class="label">拖拽玩家到这里分配队伍</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 本局排名 -->
  <div class="card">
    <h3>本局排名</h3>
    <div class="row">
      <div class="small">仅🈶1方可升级：</div><input type="checkbox" id="must1" checked>
      <span class="small muted" id="ruleHint"></span>
      <button id="clearRanking">清空排名</button>
      <button id="randomRanking">随机排名</button>
      <button id="manualCalc">手动计算</button>
    </div>
    
    <!-- 待排名玩家池 -->
    <div class="player-pool-section">
      <h4 class="small muted">待排名玩家</h4>
      <div class="player-pool" id="playerPool">
        <div class="small muted">请先分配玩家到队伍</div>
      </div>
    </div>
    
    <!-- 排名位置 -->
    <div class="ranking-section">
      <h4 class="small muted">拖拽玩家到对应排名</h4>
      <div class="ranking-area" id="rankingArea">
        <!-- Ranking slots will be generated here -->
      </div>
    </div>
    
    <div class="small muted" id="tip">从上方池中拖拽玩家到对应的排名位置</div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>结果</h3>
      <div id="headline">—</div>
      <div id="explain" class="small muted">等待输入…</div>
      <hr>
      <div class="row" id="winBtnsWrap">
        <span class="small">获胜队：</span>
        <span id="winnerDisplay" style="font-weight:bold">—</span>
        <button id="apply">应用结果到战绩</button>
        <button id="advance" title="将本局级牌推进到预览的下一局">进入下一局</button>
      </div>
      <div class="small muted">
        A 局规则：胜方带末游→本局胜但不通关，失败数+1；A连败到3（A3）→仅该队回2。<br>
        严格模式：必须在自己的A级获胜才能通关 | 宽松模式：任何时候A级获胜都可通关
      </div>
      <div class="small muted toggle" style="margin-top:6px;">
        <input type="checkbox" id="autoNext"> <label for="autoNext">应用后自动进入下一局</label>
        <br>
        <input type="checkbox" id="autoApply"> <label for="autoApply" style="color:#4ade80;font-weight:bold">✅ 排名完成后自动应用结果（升级队伍）</label>
        <br>
        <input type="checkbox" id="strictA" checked> <label for="strictA" style="color:#f59e0b">🎯 严格A级规则（必须在自己的A级获胜才能通关）</label>
      </div>
      <span class="small muted" id="applyTip"></span>
    </div>

    <div class="card">
      <h3>队伍</h3>
      <div class="team">
        <span class="chip" id="t1NameChip"><b>蓝队</b></span><span class="chip">级牌：<b id="t1Lvl">2</b></span><span class="chip">A失败：<b id="t1A">0</b>/3</span><span class="chip">A状态：<b id="t1AState">—</b></span>
      </div>
      <div class="team">
        <span class="chip" id="t2NameChip"><b>红队</b></span><span class="chip">级牌：<b id="t2Lvl">2</b></span><span class="chip">A失败：<b id="t2A">0</b>/3</span><span class="chip">A状态：<b id="t2AState">—</b></span>
      </div>
      <hr>
      <div class="team">
        <span class="chip">本局级牌：<b id="curRoundLvl">2</b></span>
        <span class="chip">下局级牌（预览）：<b id="nextRoundPreview">-</b></span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>自定义规则</h3>
    <div class="grid">
      <details open><summary>4人升级表</summary>
        <div class="row" style="margin-top:8px;">
          <div>(1,2)= <input type="number" id="c4_12" value="3" min="0" max="5"></div>
          <div>(1,3)= <input type="number" id="c4_13" value="2" min="0" max="5"></div>
          <div>(1,4)= <input type="number" id="c4_14" value="1" min="0" max="5"></div>
          <button id="save4">保存4人设置</button>
        </div>
      </details>
      <details><summary>6人阈值 & 分值</summary>
        <div class="row" style="margin-top:8px;">
          <div>升3级≥ <input type="number" id="t6_3" value="7"></div>
          <div>升2级≥ <input type="number" id="t6_2" value="4"></div>
          <div>升1级≥ <input type="number" id="t6_1" value="1"></div>
        </div>
        <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:12px;">
          <div>1名分 <input type="number" id="p6_1" value="5" style="width:80px"></div>
          <div>2名分 <input type="number" id="p6_2" value="4" style="width:80px"></div>
          <div>3名分 <input type="number" id="p6_3" value="3" style="width:80px"></div>
          <div>4名分 <input type="number" id="p6_4" value="3" style="width:80px"></div>
          <div>5名分 <input type="number" id="p6_5" value="1" style="width:80px"></div>
          <div>6名分 <input type="number" id="p6_6" value="0" style="width:80px"></div>
        </div>
        <div class="row" style="margin-top:8px;"><button id="save6">保存6人设置</button></div>
      </details>
      <details><summary>8人阈值 & 分值</summary>
        <div class="row" style="margin-top:8px;">
          <div>升3级≥ <input type="number" id="t8_3" value="11"></div>
          <div>升2级≥ <input type="number" id="t8_2" value="6"></div>
          <div>升1级≥ <input type="number" id="t8_1" value="1"></div>
        </div>
        <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:12px;">
          <div>1名分 <input type="number" id="p8_1" value="7" style="width:80px"></div>
          <div>2名分 <input type="number" id="p8_2" value="6" style="width:80px"></div>
          <div>3名分 <input type="number" id="p8_3" value="5" style="width:80px"></div>
          <div>4名分 <input type="number" id="p8_4" value="4" style="width:80px"></div>
          <div>5名分 <input type="number" id="p8_5" value="3" style="width:80px"></div>
          <div>6名分 <input type="number" id="p8_6" value="2" style="width:80px"></div>
          <div>7名分 <input type="number" id="p8_7" value="1" style="width:80px"></div>
          <div>8名分 <input type="number" id="p8_8" value="0" style="width:80px"></div>
        </div>
        <div class="row" style="margin-top:8px;"><button id="save8">保存8人设置</button></div>
      </details>
    </div>
  </div>

  <div class="card">
    <h3>历史战绩</h3>
    <div class="table-wrap">
      <table class="table" id="hist">
        <thead><tr>
          <th>#</th><th>时间</th><th>人数</th><th>胜方组合</th><th>玩家排名</th><th>升级情况</th><th>胜队</th>
          <th><span id="hT1"></span>级牌</th><th><span id="hT2"></span>级牌</th><th>本局级牌</th><th>A说明</th><th>操作</th>
        </tr></thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
    <div class="row btns-grid" style="margin-top:10px;">
      <button id="undo">撤销上一局</button>
      <button id="exportTxt">导出 TXT</button>
      <button id="exportCsv">导出 CSV</button>
      <button id="exportLongPng">导出 长图 PNG</button>
      <button id="shareGame" style="background:#3b82f6;color:white;">🔗 分享</button>
      <button id="resetMatch" style="border-color:#5b1e1e;color:#ffb3b3">重置比赛</button>
      <span id="exportTip" class="small muted" style="grid-column:1/-1"></span>
    </div>
  </div>

  <!-- 玩家统计 -->
  <div class="grid">
    <div class="card">
      <h3>玩家排名统计</h3>
      <table class="stats-table">
        <thead>
          <tr>
            <th>玩家</th>
            <th>队伍</th>
            <th>场次</th>
            <th>平均排名</th>
            <th>拿1次数</th>
            <th>垫底次数</th>
          </tr>
        </thead>
        <tbody id="playerStatsBody">
          <tr><td colspan="6" class="muted small">暂无数据</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>队伍MVP & Burden</h3>
      <div id="team1Stats" style="margin-bottom:16px">
        <h4 id="team1StatsTitle">蓝队</h4>
        <div class="row">
          <span class="badge">MVP: <span id="team1MVP">—</span></span>
          <span class="badge">Burden: <span id="team1Burden">—</span></span>
        </div>
      </div>
      <div id="team2Stats">
        <h4 id="team2StatsTitle">红队</h4>
        <div class="row">
          <span class="badge">MVP: <span id="team2MVP">—</span></span>
          <span class="badge">Burden: <span id="team2Burden">—</span></span>
        </div>
      </div>
    </div>
  </div>
</div>

<canvas id="longCnv" width="1200" height="1600" style="display:none"></canvas>

<!-- Victory Modal -->
<div id="victoryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#1a1b1c; border-radius:16px; padding:32px; max-width:500px; text-align:center; border:3px solid #4ade80; transition: all 0.3s ease;">
    <h1 style="color:#fff; font-size:36px; margin:0 0 16px 0;">🎉 A级通关！🎉</h1>
    <h2 id="victoryTeamName" style="font-size:48px; margin:0 0 24px 0; font-weight:bold; text-shadow: 0 0 20px currentColor;"></h2>
    <p style="color:#999; font-size:18px; margin-bottom:32px;">恭喜完成所有级别的挑战！</p>
    
    <div style="display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
      <button onclick="exportTXT()" style="padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        📄 导出 TXT
      </button>
      <button onclick="exportCSV()" style="padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        📊 导出 CSV
      </button>
      <button onclick="exportLongPNG()" style="padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        🖼️ 导出长图
      </button>
      <button onclick="resetAll()" style="padding:12px 24px; background:#ef4444; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        🔄 重置整场
      </button>
      <button onclick="closeVictoryModal()" style="padding:12px 24px; background:#666; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        关闭
      </button>
    </div>
  </div>
</div>

<footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #ddd; color: #666; font-size: 14px;">
  Made with ❤️ by Xingfan Xia, Claude Opus 4.1 & GPT-5 | 
  <a href="https://github.com/xingfanxia/guandan_calc" target="_blank" style="color: #4078c0; text-decoration: none;">
    GitHub
  </a>
</footer>

<script type="module" src="/src/main.js"></script>
</body>
</html>
