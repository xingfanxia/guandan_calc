<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>闹麻家族掼蛋计分器 v9.0</title>
<meta name="theme-color" content="#0b0b0c">
<link rel="stylesheet" href="/src/style.css">
</head>
<body>
<div class="wrap">
  <h1>闹麻家族掼蛋计分器 v9.0 <span class="badge">开闹</span></h1>

  <!-- 房间功能 -->
  <div class="card" id="roomControls">
    <h3>🎮 多人房间</h3>
    <div class="row">
      <button id="createRoom" style="background:#22c55e;color:white;padding:12px 20px;font-size:16px;">📺 创建房间</button>
      <button id="joinRoom" style="background:#3b82f6;color:white;padding:12px 20px;font-size:16px;">🔗 加入房间</button>
      <button id="favoriteRoomTop" style="background:#f59e0b;color:white;padding:12px 20px;font-size:16px;display:none;">⭐ 收藏房间</button>
      <button id="browseRooms" style="background:#8b5cf6;color:white;padding:12px 20px;font-size:16px;">📋 精选回顾</button>
      <span class="small muted" style="margin-left:16px;">
        创建房间与朋友实时共享比赛，或输入房间代码观看他人比赛
      </span>
    </div>
  </div>

  <!-- 玩家设置 -->
  <div class="card" id="playerSetupSection">
    <details open>
      <summary style="cursor:pointer; font-size:18px; font-weight:bold; padding:8px 0;">👥 玩家设置</summary>
      <div class="row">
        <label for="mode">人数：</label>
        <select id="mode"><option value="4">4 人</option><option value="6">6 人</option><option value="8" selected>8 人</option></select>
        <button id="generatePlayers">生成玩家</button>
        <button id="shuffleTeams">随机分配队伍</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <label for="bulkNames">批量输入姓名：</label>
        <input type="text" id="bulkNames" placeholder="豪 小 大 姐 夫 塔 帆 鱼" style="flex:1; margin-right:8px;">
        <button id="applyBulkNames">应用姓名</button>
        <button id="quickStart" style="background:#4ade80; color:white; margin-left:4px;">快速开始</button>
      </div>
      <div class="unassigned-players" id="unassignedPlayers">
        <div class="small muted" style="width:100%">点击"生成玩家"开始</div>
      </div>
      
      <div class="grid">
        <div>
          <h4 id="team1Label">蓝队</h4>
          <div class="team-drop-zone" id="team1Zone" data-team="1">
            <div class="label">拖拽玩家到这里分配队伍</div>
          </div>
        </div>
        <div>
          <h4 id="team2Label">红队</h4>
          <div class="team-drop-zone" id="team2Zone" data-team="2">
            <div class="label">拖拽玩家到这里分配队伍</div>
          </div>
        </div>
      </div>
    </details>
  </div>

  <!-- 队伍状态 -->
  <div class="card">
    <h3>队伍</h3>
    <div class="team">
      <span class="chip" id="t1NameChip"><b>蓝队</b></span><span class="chip">级牌：<b id="t1Lvl">2</b></span><span class="chip">A失败：<b id="t1A">0</b>/3</span><span class="chip">A状态：<b id="t1AState">—</b></span>
    </div>
    <div class="team">
      <span class="chip" id="t2NameChip"><b>红队</b></span><span class="chip">级牌：<b id="t2Lvl">2</b></span><span class="chip">A失败：<b id="t2A">0</b>/3</span><span class="chip">A状态：<b id="t2AState">—</b></span>
    </div>
    <hr>
    <div class="team">
      <span class="chip">本局级牌：<b id="curRoundLvl">2</b></span>
      <span class="chip">下局级牌（预览）：<b id="nextRoundPreview">-</b></span>
    </div>
  </div>

  <!-- 本局排名 -->
  <div class="card" id="rankingSection">
    <h3>本局排名</h3>
    <div class="row">
      <div class="small">仅🈶1方可升级：</div><input type="checkbox" id="must1" checked>
      <span class="small muted" id="ruleHint"></span>
      <button id="clearRanking">清空排名</button>
      <button id="randomRanking">随机排名</button>
      <button id="manualCalc">手动计算</button>
    </div>
    
    <!-- 待排名玩家池 -->
    <div class="player-pool-section">
      <h4 class="small muted">待排名玩家</h4>
      <div class="player-pool" id="playerPool">
        <div class="small muted">请先分配玩家到队伍</div>
      </div>
    </div>
    
    <!-- 排名位置 -->
    <div class="ranking-section">
      <h4 class="small muted">拖拽玩家到对应排名</h4>
      <div class="ranking-area" id="rankingArea">
        <!-- Ranking slots will be generated here -->
      </div>
    </div>
    
    <div class="small muted" id="tip">从上方池中拖拽玩家到对应的排名位置</div>
  </div>

  <div class="grid">
    <div class="card" id="resultsSection">
      <h3>结果</h3>
      <div id="headline">—</div>
      <div id="explain" class="small muted">等待输入…</div>
      <hr>
      <div class="row" id="winBtnsWrap">
        <span class="small">获胜队：</span>
        <span id="winnerDisplay" style="font-weight:bold">—</span>
        <button id="apply">应用结果到战绩</button>
        <button id="advance" title="将本局级牌推进到预览的下一局">进入下一局</button>
      </div>
      <div class="small muted">
        A 局规则：胜方带末游→本局胜但不通关，失败数+1；A连败到3（A3）→仅该队回2。<br>
        严格模式：必须在自己的A级获胜才能通关 | 宽松模式：任何时候A级获胜都可通关
      </div>
      <div class="small muted toggle" style="margin-top:6px;">
        <input type="checkbox" id="autoNext"> <label for="autoNext">应用后自动进入下一局</label>
        <br>
        <input type="checkbox" id="autoApply"> <label for="autoApply" style="color:#4ade80;font-weight:bold">✅ 排名完成后自动应用结果（升级队伍）</label>
        <br>
        <input type="checkbox" id="strictA" checked> <label for="strictA" style="color:#f59e0b">🎯 严格A级规则（必须在自己的A级获胜才能通关）</label>
      </div>
      <span class="small muted" id="applyTip"></span>
    </div>

  </div>

  <div class="card" id="customRulesSection">
    <details>
      <summary style="cursor:pointer; font-size:18px; font-weight:bold; padding:8px 0;">⚙️ 自定义规则</summary>
      <div class="grid" style="margin-top:12px;">
      <details><summary>4人升级表</summary>
        <div class="row" style="margin-top:8px;">
          <div>(1,2)= <input type="number" id="c4_12" value="3" min="0" max="5"></div>
          <div>(1,3)= <input type="number" id="c4_13" value="2" min="0" max="5"></div>
          <div>(1,4)= <input type="number" id="c4_14" value="1" min="0" max="5"></div>
          <button id="save4">保存4人设置</button>
          <button id="reset4" style="background:#6b7280; margin-left:8px;">恢复默认</button>
        </div>
      </details>
      <details><summary>6人阈值 & 分值</summary>
        <div class="row" style="margin-top:8px;">
          <div>升3级≥ <input type="number" id="t6_3" value="7"></div>
          <div>升2级≥ <input type="number" id="t6_2" value="4"></div>
          <div>升1级≥ <input type="number" id="t6_1" value="1"></div>
        </div>
        <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:12px;">
          <div>1名分 <input type="number" id="p6_1" value="5" style="width:80px"></div>
          <div>2名分 <input type="number" id="p6_2" value="4" style="width:80px"></div>
          <div>3名分 <input type="number" id="p6_3" value="3" style="width:80px"></div>
          <div>4名分 <input type="number" id="p6_4" value="3" style="width:80px"></div>
          <div>5名分 <input type="number" id="p6_5" value="1" style="width:80px"></div>
          <div>6名分 <input type="number" id="p6_6" value="0" style="width:80px"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <button id="save6">保存6人设置</button>
          <button id="reset6" style="background:#6b7280; margin-left:8px;">恢复默认</button>
        </div>
      </details>
      <details><summary>8人阈值 & 分值</summary>
        <div class="row" style="margin-top:8px;">
          <div>升3级≥ <input type="number" id="t8_3" value="11"></div>
          <div>升2级≥ <input type="number" id="t8_2" value="6"></div>
          <div>升1级≥ <input type="number" id="t8_1" value="1"></div>
        </div>
        <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:12px;">
          <div>1名分 <input type="number" id="p8_1" value="7" style="width:80px"></div>
          <div>2名分 <input type="number" id="p8_2" value="6" style="width:80px"></div>
          <div>3名分 <input type="number" id="p8_3" value="5" style="width:80px"></div>
          <div>4名分 <input type="number" id="p8_4" value="4" style="width:80px"></div>
          <div>5名分 <input type="number" id="p8_5" value="3" style="width:80px"></div>
          <div>6名分 <input type="number" id="p8_6" value="2" style="width:80px"></div>
          <div>7名分 <input type="number" id="p8_7" value="1" style="width:80px"></div>
          <div>8名分 <input type="number" id="p8_8" value="0" style="width:80px"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <button id="save8">保存8人设置</button>
          <button id="reset8" style="background:#6b7280; margin-left:8px;">恢复默认</button>
        </div>
      </details>
      </div>
    </details>
  </div>

  <!-- 玩家统计 -->
  <div class="grid">
    <div class="card">
      <h3>玩家排名统计</h3>
      <table class="stats-table">
        <thead>
          <tr>
            <th>玩家</th>
            <th>队伍</th>
            <th>场次</th>
            <th>平均排名</th>
            <th>拿1次数</th>
            <th>垫底次数</th>
          </tr>
        </thead>
        <tbody id="playerStatsBody">
          <tr><td colspan="6" class="muted small">暂无数据</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>荣誉提名</h3>
      
      <!-- 团队荣誉 -->
      <div id="team1Stats" style="margin-bottom:16px">
        <h4 id="team1StatsTitle">蓝队</h4>
        <div class="row">
          <span class="badge">很C: <span id="team1MVP">—</span></span>
          <span class="badge">很闹: <span id="team1Burden">—</span></span>
        </div>
      </div>
      <div id="team2Stats" style="margin-bottom:20px">
        <h4 id="team2StatsTitle">红队</h4>
        <div class="row">
          <span class="badge">很C: <span id="team2MVP">—</span></span>
          <span class="badge">很闹: <span id="team2Burden">—</span></span>
        </div>
      </div>
      
      <!-- 全场特殊荣誉 -->
      <div style="border-top:1px solid #333; padding-top:16px">
        <h4 class="small muted" style="margin-bottom:12px">🏆 特殊荣誉</h4>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <span class="badge" style="background:#d4af37;color:#000;">吕布: <span id="lyubu">—</span></span>
            <div class="small muted">最多第一名</div>
          </div>
          <div>
            <span class="badge" style="background:#8b4513;color:#fff;">阿斗: <span id="adou">—</span></span>
            <div class="small muted">最多垫底</div>
          </div>
          <div>
            <span class="badge" style="background:#708090;color:#fff;">石佛: <span id="shifo">—</span></span>
            <div class="small muted">优秀且稳定</div>
          </div>
          <div>
            <span class="badge" style="background:#ff4500;color:#fff;">波动王: <span id="bodongwang">—</span></span>
            <div class="small muted">排名波动最大</div>
          </div>
          <div>
            <span class="badge" style="background:#32cd32;color:#000;">奋斗王: <span id="fendouwang">—</span></span>
            <div class="small muted">排名稳步提升</div>
          </div>
          <div>
            <span class="badge" style="background:#4169e1;color:#fff;">辅助王: <span id="fuzhuwang">—</span></span>
            <div class="small muted">团队胜利时排名靠后</div>
          </div>
          <div>
            <span class="badge" style="background:#dc2626;color:#fff;">翻车王: <span id="fanchewang">—</span></span>
            <div class="small muted">前3掉垫底</div>
          </div>
          <div>
            <span class="badge" style="background:#7c3aed;color:#fff;">赌徒: <span id="dutu">—</span></span>
            <div class="small muted">高风险高回报</div>
          </div>
          <div>
            <span class="badge" style="background:#059669;color:#fff;">大满贯: <span id="damanguan">—</span></span>
            <div class="small muted">体验所有排名</div>
          </div>
          <div>
            <span class="badge" style="background:#ea580c;color:#fff;">连胜王: <span id="lianshengewang">—</span></span>
            <div class="small muted">连续好排名</div>
          </div>
          <div>
            <span class="badge" style="background:#6b7280;color:#fff;">佛系玩家: <span id="foxiwanjia">—</span></span>
            <div class="small muted">总是中游</div>
          </div>
          <div>
            <span class="badge" style="background:#059669;color:#fff;">守门员: <span id="shoumenyuan">—</span></span>
            <div class="small muted">保护队友</div>
          </div>
          <div>
            <span class="badge" style="background:#db2777;color:#fff;">慢热王: <span id="manrewang">—</span></span>
            <div class="small muted">后期发力</div>
          </div>
          <div>
            <span class="badge" style="background:#eab308;color:#000;">闪电侠: <span id="shandianxia">—</span></span>
            <div class="small muted">变化频繁</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 人民的声音 (投票系统) -->
  <div class="card" id="votingSection" style="display:none;">
    <h3>🗳️ 人民的声音</h3>
    
    <!-- 观众投票界面 -->
    <div id="voterInterface" style="display:none;">
      <h4>为本局投票</h4>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px; margin-top:16px;">
        <div>
          <h5 style="color:#22c55e;">谁最C (表现最好)？</h5>
          <div id="mvpVotingOptions" class="voting-options">
            <!-- 动态生成投票选项 -->
          </div>
        </div>
        <div>
          <h5 style="color:#ef4444;">谁最闹 (表现最差)？</h5>
          <div id="burdenVotingOptions" class="voting-options">
            <!-- 动态生成投票选项 -->
          </div>
        </div>
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button id="submitVote" style="background:#3b82f6;color:white;padding:12px 24px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">🗳️ 提交投票</button>
      </div>
    </div>
    
    <!-- 房主投票结果界面 -->
    <div id="hostVotingInterface" style="display:none;">
      <h4>观众投票结果</h4>
      <div id="votingResults" style="margin-top:16px;">
        <!-- 动态显示投票结果 -->
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button id="confirmHostSelection" style="background:#22c55e;color:white;padding:12px 24px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">✅ 确认选择</button>
      </div>
    </div>
    
    <!-- 投票统计面板 -->
    <div id="votingStats" style="margin-top:20px; padding-top:20px; border-top:1px solid #333;">
      <h4>📊 投票统计</h4>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px; margin-top:16px;">
        <div>
          <h5 style="color:#22c55e;">最C次数排行</h5>
          <div id="mvpStatsTable">
            <!-- 动态生成统计 -->
          </div>
        </div>
        <div>
          <h5 style="color:#ef4444;">最闹次数排行</h5>
          <div id="burdenStatsTable">
            <!-- 动态生成统计 -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>历史战绩</h3>
    <div class="table-wrap">
      <table class="table" id="hist">
        <thead><tr>
          <th>#</th><th>时间</th><th>人数</th><th>胜方组合</th><th>玩家排名</th><th>升级情况</th><th>胜队</th>
          <th><span id="hT1"></span>级牌</th><th><span id="hT2"></span>级牌</th><th>本局级牌</th><th>A说明</th><th>操作</th>
        </tr></thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
    <div class="row btns-grid" style="margin-top:10px;">
      <button id="undo">撤销上一局</button>
      <button id="exportTxt">导出 TXT</button>
      <button id="exportCsv">导出 CSV</button>
      <button id="exportLongPng">导出 长图 PNG</button>
      <button id="exportMobilePng" style="background:#10b981;color:white;">📱 手机版 PNG</button>
      <button id="shareGame" style="background:#8b5cf6;color:white;">📤 分享快照</button>
      <button id="favoriteRoom" style="background:#f59e0b;color:white;display:none;">⭐ 收藏房间</button>
      <button id="resetMatch" style="border-color:#5b1e1e;color:#ffb3b3">重置比赛</button>
      <span id="exportTip" class="small muted" style="grid-column:1/-1"></span>
    </div>
  </div>
</div>

<canvas id="longCnv" width="1200" height="1600" style="display:none"></canvas>

<!-- Victory Modal -->
<div id="victoryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center; overflow-y: auto; padding: 20px 0;">
  <div style="background:#1a1b1c; border-radius:16px; padding:32px; max-width:500px; text-align:center; border:3px solid #4ade80; transition: all 0.3s ease; max-height: 90vh; overflow-y: auto; margin: auto;">
    <h1 style="color:#fff; font-size:36px; margin:0 0 16px 0;">🎉 A级通关！🎉</h1>
    <h2 id="victoryTeamName" style="font-size:48px; margin:0 0 24px 0; font-weight:bold; text-shadow: 0 0 20px currentColor;"></h2>
    <p style="color:#999; font-size:18px; margin-bottom:24px;">恭喜完成所有级别的挑战！</p>

    <!-- Voting Interface Container -->
    <div id="victoryVoting" style="margin-bottom:24px;"></div>

    <div style="display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
      <button onclick="exportTXT()" style="padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        📄 导出 TXT
      </button>
      <button onclick="exportCSV()" style="padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        📊 导出 CSV
      </button>
      <button onclick="exportLongPNG()" style="padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        🖼️ 导出长图
      </button>
      <button onclick="exportMobilePNG()" style="padding:12px 24px; background:#10b981; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        📱 手机版
      </button>
      <button onclick="resetAll()" style="padding:12px 24px; background:#ef4444; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        🔄 重置整场
      </button>
      <button onclick="closeVictoryModal()" style="padding:12px 24px; background:#666; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        关闭
      </button>
    </div>
  </div>
</div>

<footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #ddd; color: #666; font-size: 14px;">
  Made with ❤️ by Xingfan Xia, Claude Sonnet 4.1 1M Context & GPT-5 | 
  <a href="https://github.com/xingfanxia/guandan_calc" target="_blank" style="color: #4078c0; text-decoration: none;">
    GitHub
  </a>
</footer>

<script type="module" src="/src/main.js"></script>
</body>
</html>
