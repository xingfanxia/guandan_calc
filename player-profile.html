<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ç©å®¶èµ„æ–™ - æ¼è›‹è®¡åˆ†å™¨</title>
<meta name="theme-color" content="#0b0b0c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="æ¼è›‹è®¡åˆ†å™¨">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link rel="stylesheet" href="/src/style.css">
<style>
  .profile-header {
    text-align: center;
    padding: 32px 16px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
    border-radius: 12px;
    margin-bottom: 24px;
  }
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin: 16px 0;
  }
  .stat-item {
    background: #1a1a1a;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #333;
  }
  .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #22c55e;
    display: block;
    margin-bottom: 4px;
  }
  .stat-label {
    font-size: 0.85em;
    color: #888;
  }
  .honor-badge {
    display: inline-block;
    background: #2a2a2a;
    border: 1px solid #444;
    padding: 8px 12px;
    border-radius: 6px;
    margin: 4px;
  }
  .game-row {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  .game-row:hover {
    background: #252525;
    border-color: #444;
  }
</style>
</head>
<body>
<div class="wrap">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h1>ç©å®¶èµ„æ–™</h1>
    <div>
      <button
        id="editProfileBtn"
        style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 16px; font-size: 14px; font-weight: 500; transition: all 0.2s;"
        onmouseover="this.style.background='#2563eb'"
        onmouseout="this.style.background='#3b82f6'"
      >
        âœï¸ ç¼–è¾‘èµ„æ–™
      </button>
      <a href="/players.html" style="color: #3b82f6; text-decoration: none; margin-right: 16px;">æµè§ˆæ‰€æœ‰ç©å®¶</a>
      <a href="/" style="color: #3b82f6; text-decoration: none;">è¿”å›æ¸¸æˆ</a>
    </div>
  </div>

  <div id="profileContent">
    <div style="text-align: center; padding: 40px; color: #888;">
      åŠ è½½ä¸­...
    </div>
  </div>
</div>

<script type="module">
import { getPlayer, getPlayStyleLabel } from '/src/api/playerApi.js';
import { ACHIEVEMENTS } from '/src/stats/achievements.js';
import { Chart, registerables } from 'chart.js';
import { renderProfileAvatar } from '/src/player/photoRenderer.js';
import { showEditModal, initializeEditModal } from '/src/player/playerEditModal.js';

// Register Chart.js components
Chart.register(...registerables);

// Format duration in seconds to readable string
function formatDuration(seconds) {
  if (!seconds) return '';
  const hours = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  
  if (hours > 0) {
    return `${hours}å°æ—¶${mins}åˆ†`;
  }
  return `${mins}åˆ†é’Ÿ`;
}

// Render partner/rival statistics
function renderPartnerRivalStats(player) {
  const partners = player.stats.partners || {};
  const opponents = player.stats.opponents || {};

  if (Object.keys(partners).length === 0 && Object.keys(opponents).length === 0) {
    return '';  // Don't show section if no data
  }

  // Find best/worst partners
  const partnerStats = Object.entries(partners).map(([handle, stats]) => ({
    handle,
    ...stats
  })).sort((a, b) => b.winRate - a.winRate);

  const bestPartner = partnerStats.length > 0 ? partnerStats[0] : null;
  const worstPartner = partnerStats.length > 0 ? partnerStats[partnerStats.length - 1] : null;

  // Find hardest/easiest opponents
  const opponentStats = Object.entries(opponents).map(([handle, stats]) => ({
    handle,
    ...stats
  })).sort((a, b) => a.winRate - b.winRate);  // Sort ascending for hardest

  const hardestOpponent = opponentStats.length > 0 ? opponentStats[0] : null;
  const easiestOpponent = opponentStats.length > 0 ? opponentStats[opponentStats.length - 1] : null;

  return `
    <div class="card">
      <h3>ğŸ¤ é˜Ÿå‹ä¸å¯¹æ‰‹</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
        <!-- Best/Worst Partners -->
        <div>
          <h4 style="font-size: 16px; color: #888; margin-bottom: 12px;">é˜Ÿå‹</h4>
          ${bestPartner ? `
            <div style="background: #1a2e1a; border: 1px solid #22c55e; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="viewProfile('${bestPartner.handle}')">
              <div style="color: #22c55e; font-weight: bold; margin-bottom: 4px;">ğŸ† å¤§ä½¬å¸¦æˆ‘èººèµ¢</div>
              <div style="font-size: 18px;">@${bestPartner.handle}</div>
              <div style="color: #888; font-size: 0.9em; margin-top: 4px;">
                ${bestPartner.games}åœº Â· ${bestPartner.wins}èƒœ Â· ${(bestPartner.winRate * 100).toFixed(1)}%èƒœç‡
              </div>
            </div>
          ` : ''}
          ${worstPartner && worstPartner.handle !== bestPartner?.handle && partnerStats.length > 1 ? `
            <div style="background: #2a1a1a; border: 1px solid #ef4444; padding: 12px; border-radius: 8px; cursor: pointer;" onclick="viewProfile('${worstPartner.handle}')">
              <div style="color: #ef4444; font-weight: bold; margin-bottom: 4px;">ğŸ˜… ä½ å°±å·ç€ä¹å§</div>
              <div style="font-size: 18px;">@${worstPartner.handle}</div>
              <div style="color: #888; font-size: 0.9em; margin-top: 4px;">
                ${worstPartner.games}åœº Â· ${worstPartner.wins}èƒœ Â· ${(worstPartner.winRate * 100).toFixed(1)}%èƒœç‡
              </div>
            </div>
          ` : ''}
        </div>

        <!-- Hardest/Easiest Opponents -->
        <div>
          <h4 style="font-size: 16px; color: #888; margin-bottom: 12px;">å¯¹æ‰‹</h4>
          ${hardestOpponent ? `
            <div style="background: #2a1a2a; border: 1px solid #a855f7; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="viewProfile('${hardestOpponent.handle}')">
              <div style="color: #a855f7; font-weight: bold; margin-bottom: 4px;">âš”ï¸ æ—¢ç”Ÿç‘œä½•ç”Ÿäº®</div>
              <div style="font-size: 18px;">@${hardestOpponent.handle}</div>
              <div style="color: #888; font-size: 0.9em; margin-top: 4px;">
                ${hardestOpponent.games}åœº Â· ${hardestOpponent.wins}èƒœ Â· ${(hardestOpponent.winRate * 100).toFixed(1)}%èƒœç‡
              </div>
            </div>
          ` : ''}
          ${easiestOpponent && easiestOpponent.handle !== hardestOpponent?.handle && opponentStats.length > 1 ? `
            <div style="background: #1a2a1a; border: 1px solid #3b82f6; padding: 12px; border-radius: 8px; cursor: pointer;" onclick="viewProfile('${easiestOpponent.handle}')">
              <div style="color: #3b82f6; font-weight: bold; margin-bottom: 4px;">ğŸ è¿™æ˜¯é€åˆ†æ¥çš„</div>
              <div style="font-size: 18px;">@${easiestOpponent.handle}</div>
              <div style="color: #888; font-size: 0.9em; margin-top: 4px;">
                ${easiestOpponent.games}åœº Â· ${easiestOpponent.wins}èƒœ Â· ${(easiestOpponent.winRate * 100).toFixed(1)}%èƒœç‡
              </div>
            </div>
          ` : ''}
        </div>
      </div>

      <!-- All Partners List -->
      ${partnerStats.length > 0 ? `
        <div style="margin-top: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="font-size: 16px; color: #888; margin: 0;">æ‰€æœ‰é˜Ÿå‹ (${partnerStats.length})</h4>
            <select id="partnerSort" style="padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff;">
              <option value="winrate">æŒ‰èƒœç‡æ’åº</option>
              <option value="games">æŒ‰åœºæ¬¡æ’åº</option>
              <option value="wins">æŒ‰èƒœåœºæ’åº</option>
            </select>
          </div>
          <div style="background: #1a1a1a; padding: 16px; border-radius: 8px; border: 1px solid #333;">
            <canvas id="partnersChart" style="max-height: 400px;"></canvas>
          </div>
        </div>
      ` : ''}

      <!-- All Opponents List -->
      ${opponentStats.length > 0 ? `
        <div style="margin-top: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="font-size: 16px; color: #888; margin: 0;">æ‰€æœ‰å¯¹æ‰‹ (${opponentStats.length})</h4>
            <select id="opponentSort" style="padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff;">
              <option value="winrate">æŒ‰èƒœç‡æ’åº</option>
              <option value="games">æŒ‰åœºæ¬¡æ’åº</option>
              <option value="wins">æŒ‰èƒœåœºæ’åº</option>
            </select>
          </div>
          <div style="background: #1a1a1a; padding: 16px; border-radius: 8px; border: 1px solid #333;">
            <canvas id="opponentsChart" style="max-height: 400px;"></canvas>
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function viewProfile(handle) {
  window.location.href = '/player-profile.html?handle=' + handle;
}

function renderRecentRankingsChart(recentRankings) {
  const canvas = document.getElementById('recentRankingsChart');
  if (!canvas || !recentRankings || recentRankings.length === 0) return;

  const ctx = canvas.getContext('2d');
  
  // Reverse so oldest is on the left, newest on the right
  const rankings = [...recentRankings].reverse();
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: rankings.map((_, i) => `ç¬¬${i + 1}åœº`),
      datasets: [{
        label: 'æ’å',
        data: rankings,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: rankings.map(rank => 
          rank === 1 ? '#22c55e' : rank <= 3 ? '#3b82f6' : '#ef4444'
        ),
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2.5,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `æ’å: #${context.parsed.y}`;
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 10,
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#333',
          borderWidth: 1
        }
      },
      scales: {
        y: {
          reverse: true, // Lower ranking number is better
          min: 1,
          max: 8,
          ticks: {
            stepSize: 1,
            color: '#888',
            callback: function(value) {
              return '#' + value;
            }
          },
          grid: {
            color: '#333',
            drawBorder: false
          }
        },
        x: {
          ticks: {
            color: '#888',
            maxRotation: 0,
            autoSkip: true,
            maxTicksLimit: 10
          },
          grid: {
            display: false
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

function renderPartnersChart(stats, sortBy) {
  const canvas = document.getElementById('partnersChart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  
  // Sort data
  let sorted = [...stats];
  if (sortBy === 'games') {
    sorted.sort((a, b) => b.games - a.games);
  } else if (sortBy === 'wins') {
    sorted.sort((a, b) => b.wins - a.wins);
  } else {
    sorted.sort((a, b) => b.winRate - a.winRate);
  }

  // Destroy previous chart if exists
  if (window.partnersChartInstance) {
    window.partnersChartInstance.destroy();
  }

  window.partnersChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(p => `@${p.handle}`),
      datasets: [{
        label: 'èƒœç‡',
        data: sorted.map(p => (p.winRate * 100).toFixed(1)),
        backgroundColor: sorted.map(p => 
          p.winRate >= 0.6 ? 'rgba(34, 197, 94, 0.8)' :
          p.winRate >= 0.5 ? 'rgba(59, 130, 246, 0.8)' :
          'rgba(239, 68, 68, 0.8)'
        ),
        borderColor: sorted.map(p => 
          p.winRate >= 0.6 ? '#22c55e' :
          p.winRate >= 0.5 ? '#3b82f6' :
          '#ef4444'
        ),
        borderWidth: 2
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const handle = sorted[index].handle;
          viewProfile(handle);
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const data = sorted[context.dataIndex];
              return [
                `èƒœç‡: ${context.parsed.x}%`,
                `åœºæ¬¡: ${data.games}åœº`,
                `èƒœåœº: ${data.wins}èƒœ`
              ];
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#333',
          borderWidth: 1
        }
      },
      scales: {
        x: {
          min: 0,
          max: 100,
          ticks: {
            color: '#888',
            callback: function(value) {
              return value + '%';
            }
          },
          grid: {
            color: '#333',
            drawBorder: false
          }
        },
        y: {
          ticks: {
            color: '#888',
            font: {
              size: sorted.length > 10 ? 10 : 12
            },
            autoSkip: false,
            maxRotation: 0,
            minRotation: 0
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
}

function renderOpponentsChart(stats, sortBy) {
  const canvas = document.getElementById('opponentsChart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  
  // Sort data - for opponents, lower win rate means tougher opponent
  let sorted = [...stats];
  if (sortBy === 'games') {
    sorted.sort((a, b) => b.games - a.games);
  } else if (sortBy === 'wins') {
    sorted.sort((a, b) => b.wins - a.wins);
  } else {
    sorted.sort((a, b) => a.winRate - b.winRate); // Ascending - hardest first
  }

  // Destroy previous chart if exists
  if (window.opponentsChartInstance) {
    window.opponentsChartInstance.destroy();
  }

  window.opponentsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(p => `@${p.handle}`),
      datasets: [{
        label: 'å¯¹æ‰‹èƒœç‡',
        data: sorted.map(p => (p.winRate * 100).toFixed(1)),
        backgroundColor: sorted.map(p => 
          p.winRate <= 0.4 ? 'rgba(34, 197, 94, 0.8)' :  // You win a lot = green
          p.winRate <= 0.5 ? 'rgba(59, 130, 246, 0.8)' :
          'rgba(239, 68, 68, 0.8)'  // They win a lot = red (tough)
        ),
        borderColor: sorted.map(p => 
          p.winRate <= 0.4 ? '#22c55e' :
          p.winRate <= 0.5 ? '#3b82f6' :
          '#ef4444'
        ),
        borderWidth: 2
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const handle = sorted[index].handle;
          viewProfile(handle);
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const data = sorted[context.dataIndex];
              return [
                `ä½ çš„èƒœç‡: ${context.parsed.x}%`,
                `åœºæ¬¡: ${data.games}åœº`,
                `èƒœåœº: ${data.wins}èƒœ`
              ];
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#333',
          borderWidth: 1
        }
      },
      scales: {
        x: {
          min: 0,
          max: 100,
          ticks: {
            color: '#888',
            callback: function(value) {
              return value + '%';
            }
          },
          grid: {
            color: '#333',
            drawBorder: false
          }
        },
        y: {
          ticks: {
            color: '#888',
            font: {
              size: sorted.length > 10 ? 10 : 12
            },
            autoSkip: false,
            maxRotation: 0,
            minRotation: 0
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
}

function setupPartnerRivalHandlers(player) {
  const partners = player.stats.partners || {};
  const opponents = player.stats.opponents || {};
  
  const partnerStats = Object.entries(partners).map(([handle, stats]) => ({
    handle,
    ...stats
  })).sort((a, b) => b.winRate - a.winRate);

  const opponentStats = Object.entries(opponents).map(([handle, stats]) => ({
    handle,
    ...stats
  })).sort((a, b) => a.winRate - b.winRate);

  // Store data for re-sorting
  window.partnerStatsData = partnerStats;
  window.opponentStatsData = opponentStats;

  // Partner sort handler
  const partnerSort = document.getElementById('partnerSort');
  if (partnerSort) {
    partnerSort.addEventListener('change', (e) => {
      const sortBy = e.target.value;
      renderPartnersChart(window.partnerStatsData, sortBy);
    });
  }

  // Opponent sort handler
  const opponentSort = document.getElementById('opponentSort');
  if (opponentSort) {
    opponentSort.addEventListener('change', (e) => {
      const sortBy = e.target.value;
      renderOpponentsChart(window.opponentStatsData, sortBy);
    });
  }
}

// Get handle from URL query parameter
const urlParams = new URLSearchParams(window.location.search);
const handle = urlParams.get('handle');

if (!handle) {
  document.getElementById('profileContent').innerHTML = `
    <div class="card" style="text-align: center; padding: 40px;">
      <h2 style="color: #ef4444;">é”™è¯¯</h2>
      <p style="color: #888;">ç¼ºå°‘ç©å®¶ç”¨æˆ·åå‚æ•°</p>
      <p style="margin-top: 16px;">
        <a href="/players.html" style="color: #3b82f6;">æµè§ˆæ‰€æœ‰ç©å®¶</a>
      </p>
    </div>
  `;
} else {
  loadProfile(handle);
}

async function loadProfile(handle) {
  try {
    const result = await getPlayer(handle);
    const player = result.player;

    const topHonors = Object.entries(player.stats.honors)
      .filter(([_, count]) => count > 0)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    document.getElementById('profileContent').innerHTML = `
      <!-- Profile Header -->
      <div class="profile-header">
        <div style="margin-bottom: 16px; display: flex; justify-content: center;">
          ${renderProfileAvatar(player, 120, { marginRight: false, borderWidth: 3 })}
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 36px;">${player.displayName}</h2>
        <div style="color: #888; font-size: 18px; margin-bottom: 8px;">@${player.handle}</div>
        <div style="color: #888; font-size: 16px; margin-bottom: 16px;">
          ${getPlayStyleLabel(player.playStyle)}
        </div>
        <div style="font-style: italic; color: #fbbf24; font-size: 20px;">
          "${player.tagline}"
        </div>
      </div>

      <!-- Mode Switcher Tabs -->
      <div class="card" style="padding: 16px;">
        <div class="mode-tabs" style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
          <button class="mode-tab active" data-mode="all" style="padding: 8px 16px; background: #22c55e; color: black; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
            å…¨éƒ¨
          </button>
          <button class="mode-tab" data-mode="4P" style="padding: 8px 16px; background: #333; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
            4äºº
          </button>
          <button class="mode-tab" data-mode="6P" style="padding: 8px 16px; background: #333; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
            6äºº
          </button>
          <button class="mode-tab" data-mode="8P" style="padding: 8px 16px; background: #333; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
            8äºº
          </button>
        </div>
      </div>

      <!-- Career Stats (will be dynamically updated) -->
      <div class="card" id="statsCard">
        <h3 id="statsTitle">ğŸ“Š ç”Ÿæ¶¯ç»Ÿè®¡ (å…¨éƒ¨æ¨¡å¼)</h3>
        
        <h4 style="font-size: 16px; color: #888; margin: 16px 0 12px 0;">æ¸¸æˆåœºæ¬¡ (å®Œæ•´å¯¹å±€)</h4>
        <div class="stat-grid">
          <div class="stat-item">
            <span class="stat-value">${player.stats.sessionsPlayed || player.stats.gamesPlayed || 0}</span>
            <span class="stat-label">æ¸¸æˆåœºæ¬¡</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${player.stats.sessionsWon || player.stats.wins || 0}</span>
            <span class="stat-label">è·èƒœåœºæ¬¡</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${((player.stats.sessionWinRate || player.stats.winRate || 0) * 100).toFixed(1)}%</span>
            <span class="stat-label">èƒœç‡</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${(player.stats.avgRankingPerSession || player.stats.avgRanking || 0).toFixed(2)}</span>
            <span class="stat-label">åœºå‡æ’å</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${Math.round(player.stats.avgRoundsPerSession || 30)}</span>
            <span class="stat-label">åœºå‡å±€æ•°</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${player.stats.longestSessionRounds || 0}</span>
            <span class="stat-label">æœ€é•¿å±€æ•°</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${player.stats.currentWinStreak}</span>
            <span class="stat-label">å½“å‰è¿èƒœ</span>
          </div>
        </div>

        <h4 style="font-size: 16px; color: #888; margin: 16px 0 12px 0;">å•å±€æ•°æ® (æ‰€æœ‰è½®æ¬¡)</h4>
        <div class="stat-grid">
          <div class="stat-item">
            <span class="stat-value">${player.stats.roundsPlayed || 0}</span>
            <span class="stat-label">æ€»è½®æ¬¡</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${(player.stats.avgRankingPerRound || player.stats.avgRanking || 0).toFixed(2)}</span>
            <span class="stat-label">å±€å‡æ’å</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${player.stats.longestWinStreak}</span>
            <span class="stat-label">æœ€é•¿è¿èƒœ</span>
          </div>
        </div>

        <h4 style="font-size: 16px; color: #888; margin: 16px 0 12px 0;">æ¸¸æˆæ—¶é•¿</h4>
        <div class="stat-grid">
          <div class="stat-item">
            <span class="stat-value">${formatDuration(player.stats.totalPlayTimeSeconds || 0)}</span>
            <span class="stat-label">æ€»æ¸¸æˆæ—¶é•¿</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${formatDuration(player.stats.longestSessionSeconds || 0)}</span>
            <span class="stat-label">æœ€é•¿å¯¹å±€</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${formatDuration(player.stats.avgSessionSeconds || 0)}</span>
            <span class="stat-label">åœºå‡æ—¶é•¿</span>
          </div>
        </div>

        ${player.stats.recentRankings && player.stats.recentRankings.length > 0 ? `
          <div style="margin-top: 16px; background: #1a1a1a; padding: 16px; border-radius: 8px; border: 1px solid #333;">
            <h4 style="font-size: 14px; color: #888; margin-bottom: 12px;">æœ€è¿‘${player.stats.recentRankings.length}åœºå¯¹å±€æ’åè¶‹åŠ¿</h4>
            <canvas id="recentRankingsChart" style="max-height: 200px;"></canvas>
          </div>
        ` : ''}
      </div>

      <!-- Honor Collection -->
      <div class="card">
        <h3>ğŸ† è£èª‰æ”¶è— (${topHonors.length > 0 ? topHonors.reduce((sum, [_, count]) => sum + count, 0) : 0} ä¸ª)</h3>
        ${topHonors.length > 0 ? `
          <div style="margin-top: 12px;">
            ${topHonors.map(([honor, count]) => `
              <div class="honor-badge">
                <strong>${honor}</strong> Ã— ${count}
              </div>
            `).join('')}
          </div>
          ${Object.keys(player.stats.honors).length > topHonors.length ? `
            <div style="margin-top: 12px; color: #888; font-size: 0.9em;">
              + å…¶ä»– ${Object.keys(player.stats.honors).filter(h => player.stats.honors[h] === 0).length} ä¸ªè£èª‰å¾…è§£é”
            </div>
          ` : ''}
        ` : '<div style="color: #888; margin-top: 12px;">æš‚æ— è£èª‰ï¼Œç»§ç»­åŠ æ²¹ï¼</div>'}
      </div>

      <!-- Community Voting -->
      <div class="card">
        <h3>ğŸ—³ï¸ è§‚ä¼—æŠ•ç¥¨</h3>
        <div class="stat-grid">
          <div class="stat-item">
            <span class="stat-value" style="color: #22c55e;">${player.stats.mvpVotes || 0}</span>
            <span class="stat-label">MVP å¾—ç¥¨</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" style="color: #ef4444;">${player.stats.burdenVotes || 0}</span>
            <span class="stat-label">ç´¯èµ˜ å¾—ç¥¨</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${((player.stats.mvpVotes || 0) + (player.stats.burdenVotes || 0))}</span>
            <span class="stat-label">æ€»å¾—ç¥¨æ•°</span>
          </div>
        </div>
        ${(player.stats.mvpVotes || 0) === 0 && (player.stats.burdenVotes || 0) === 0 ? `
          <div style="color: #888; margin-top: 12px; font-size: 0.9em;">
            æš‚æ— æŠ•ç¥¨è®°å½•ã€‚åœ¨æˆ¿é—´æ¨¡å¼ä¸­ï¼Œè§‚ä¼—å¯ä»¥ä¸ºå–œæ¬¢çš„ç©å®¶æŠ•ç¥¨ã€‚
          </div>
        ` : ''}
      </div>

      <!-- Partner/Rival Statistics -->
      ${renderPartnerRivalStats(player)}

      <!-- Achievements -->
      <div class="card">
        <h3>ğŸ–ï¸ æˆå°±å¾½ç«  (${player.achievements ? player.achievements.length : 0}/20)</h3>
        ${player.achievements && player.achievements.length > 0 ? `
          <div style="margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
            ${player.achievements.map(achId => {
              const ach = ACHIEVEMENTS[achId];
              return ach ? `
                <div style="background: #2a2a2a; border: 1px solid #444; padding: 12px; border-radius: 8px;">
                  <div style="font-size: 32px; margin-bottom: 8px;">${ach.badge}</div>
                  <div style="font-weight: bold; margin-bottom: 4px;">${ach.name}</div>
                  <div style="font-size: 0.85em; color: #888;">${ach.desc}</div>
                </div>
              ` : '';
            }).join('')}
          </div>
        ` : '<div style="color: #888; margin-top: 12px;">æš‚æ— æˆå°±ï¼Œå¼€å§‹æ¸¸æˆè§£é”å¾½ç« ï¼</div>'}
      </div>

      <!-- Recent Games -->
      <div class="card">
        <h3>ğŸ“œ æœ€è¿‘æ¸¸æˆ (${player.recentGames.length})</h3>
        ${player.recentGames.length > 0 ? `
          <div style="margin-top: 12px;">
            ${player.recentGames.slice(0, 10).map(game => `
              <div class="game-row" onclick="location.href='/?room=${game.roomCode}'">
                <div style="flex: 1;">
                  <div style="margin-bottom: 4px;">
                    <strong style="color: ${game.teamWon ? '#22c55e' : '#ef4444'};">
                      ${game.teamWon ? 'âœ… èƒœ' : 'âŒ è´Ÿ'}
                    </strong>
                    Â· ${game.mode} Â· å¹³å‡${game.ranking}å Â· ${game.rounds}è½®
                    ${game.duration ? ` Â· ${formatDuration(game.duration)}` : ''}
                  </div>
                  <div style="font-size: 0.85em; color: #888;">
                    ${new Date(game.date).toLocaleString('zh-CN')}
                    ${game.roomCode !== 'LOCAL' ? ` Â· æˆ¿é—´ ${game.roomCode}` : ''}
                  </div>
                  ${game.honorsEarned && game.honorsEarned.length > 0 ? `
                    <div style="font-size: 0.85em; color: #fbbf24; margin-top: 4px;">
                      ğŸ† ${game.honorsEarned.join(', ')}
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        ` : '<div style="color: #888; margin-top: 12px;">æš‚æ— æ¸¸æˆè®°å½•</div>'}
      </div>
    `;

    // Setup event handlers for partner/rival sorting after HTML is inserted
    setupPartnerRivalHandlers(player);

    // Render recent rankings chart
    renderRecentRankingsChart(player.stats.recentRankings);

    // Render initial partner/opponent charts
    if (window.partnerStatsData && window.partnerStatsData.length > 0) {
      renderPartnersChart(window.partnerStatsData, 'winrate');
    }
    if (window.opponentStatsData && window.opponentStatsData.length > 0) {
      renderOpponentsChart(window.opponentStatsData, 'winrate');
    }

    // Setup edit profile button
    const editBtn = document.getElementById('editProfileBtn');
    if (editBtn && player) {
      // Initialize edit modal with callback
      initializeEditModal((updatedPlayer) => {
        console.log('Profile updated:', updatedPlayer);
        // Reload page to show updated data
        window.location.reload();
      });

      editBtn.addEventListener('click', () => {
        showEditModal(player);
      });
    }

    // Setup mode tab switcher
    const modeTabs = document.querySelectorAll('.mode-tab');
    modeTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const selectedMode = tab.dataset.mode;

        // Update active tab styling
        modeTabs.forEach(t => {
          if (t === tab) {
            t.style.background = '#22c55e';
            t.style.color = 'black';
            t.classList.add('active');
          } else {
            t.style.background = '#333';
            t.style.color = 'white';
            t.classList.remove('active');
          }
        });

        // Get stats for selected mode
        const stats = selectedMode === 'all' ? player.stats : player.stats[`stats${selectedMode}`];

        if (!stats) {
          console.warn(`No stats found for mode: ${selectedMode}`);
          return;
        }

        // Update stats title
        const statsTitle = document.getElementById('statsTitle');
        if (statsTitle) {
          const modeLabel = {
            'all': 'å…¨éƒ¨æ¨¡å¼',
            '4P': '4äººæ¨¡å¼',
            '6P': '6äººæ¨¡å¼',
            '8P': '8äººæ¨¡å¼'
          }[selectedMode];
          statsTitle.textContent = `ğŸ“Š ç”Ÿæ¶¯ç»Ÿè®¡ (${modeLabel})`;
        }

        // Update stat values (reuse existing DOM elements)
        const statValues = document.querySelectorAll('.stat-value');
        const statData = [
          stats.sessionsPlayed || stats.gamesPlayed || 0,
          stats.sessionsWon || stats.wins || 0,
          ((stats.sessionWinRate || stats.winRate || 0) * 100).toFixed(1) + '%',
          (stats.avgRankingPerSession || stats.avgRanking || 0).toFixed(2),
          Math.round(stats.avgRoundsPerSession || 30),
          stats.longestSessionRounds || 0
        ];

        statValues.forEach((el, i) => {
          if (statData[i] !== undefined) {
            el.textContent = statData[i];
          }
        });

        // Update recent rankings chart with mode-specific data
        if (stats.recentRankings) {
          renderRecentRankingsChart(stats.recentRankings);
        }

        console.log(`Switched to ${selectedMode} mode:`, stats);
      });
    });

  } catch (error) {
    console.error('Failed to load profile:', error);
    document.getElementById('profileContent').innerHTML = `
      <div class="card" style="text-align: center; padding: 40px;">
        <h2 style="color: #ef4444;">åŠ è½½å¤±è´¥</h2>
        <p style="color: #888;">${error.message}</p>
        <p style="margin-top: 16px;">
          <a href="/players.html" style="color: #3b82f6;">æµè§ˆæ‰€æœ‰ç©å®¶</a>
        </p>
      </div>
    `;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // Assuming loadProfile is called elsewhere to load the player data
  // Once the player data is loaded, call setupPartnerRivalHandlers
  // For now, we'll just call it here to demonstrate
  const player = {
    stats: {
      partners: {
        'partner1': { games: 10, wins: 5, winRate: 0.5 },
        'partner2': { games: 8, wins: 3, winRate: 0.375 },
        'partner3': { games: 6, wins: 2, winRate: 0.333 }
      },
      opponents: {
        'opponent1': { games: 12, wins: 7, winRate: 0.583 },
        'opponent2': { games: 10, wins: 4, winRate: 0.4 },
        'opponent3': { games: 8, wins: 2, winRate: 0.25 }
      }
    }
  };
  setupPartnerRivalHandlers(player);
});
</script>
</body>
</html>
