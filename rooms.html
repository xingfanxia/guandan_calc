<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>æˆ¿é—´æµè§ˆå™¨ - æ¼è›‹è®¡åˆ†å™¨</title>
<meta name="theme-color" content="#0b0b0c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="æ¼è›‹è®¡åˆ†å™¨">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link rel="stylesheet" href="/src/style.css">
<style>
  /* Modern Tab Navigation */
  .nav-tabs {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
    padding: 6px;
    background: #1a1a1a;
    border-radius: 12px;
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
  }
  
  .nav-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
  }
  
  .nav-tab:not(.active) {
    color: #888;
    background: transparent;
  }
  
  .nav-tab:not(.active):hover {
    color: #fff;
    background: #252525;
  }
  
  .nav-tab.active {
    color: #fff;
    background: #3b82f6;
  }
  
  .nav-tab-icon {
    font-size: 18px;
  }

  .room-card {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: pointer;
    position: relative;
  }
  .room-card:hover {
    background: #252525;
    border-color: #444;
    transform: translateY(-2px);
  }
  .room-card.favorite {
    border-color: #fbbf24;
  }
  .room-card.favorite::before {
    content: 'â­';
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 1.2em;
  }
  .room-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  .room-code {
    font-size: 1.3em;
    font-weight: bold;
    color: #3b82f6;
    margin-bottom: 8px;
  }
  .room-info {
    color: #888;
    font-size: 0.9em;
    margin: 4px 0;
  }
  .player-tag {
    display: inline-block;
    background: #2a2a2a;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    margin: 2px;
    color: #3b82f6;
  }
  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
  }
  .status-active {
    background: #22c55e;
    color: white;
  }
  .status-finished {
    background: #888;
    color: white;
  }
  .filter-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .filter-tab {
    padding: 8px 16px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    color: #888;
  }
  .filter-tab:hover {
    background: #252525;
    color: #fff;
  }
  .filter-tab.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ  æˆ¿é—´æµè§ˆå™¨</h1>

  <!-- Modern Navigation Tabs -->
  <div class="nav-tabs">
    <a href="/players.html" class="nav-tab">
      <span class="nav-tab-icon">ğŸ‘¥</span>
      <span>æµè§ˆç©å®¶</span>
    </a>
    <a href="/rooms.html" class="nav-tab active">
      <span class="nav-tab-icon">ğŸ </span>
      <span>æµè§ˆæˆ¿é—´</span>
    </a>
    <a href="/" class="nav-tab">
      <span class="nav-tab-icon">ğŸ®</span>
      <span>æ¸¸æˆ</span>
    </a>
  </div>

  <div class="card">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">å…¨éƒ¨æˆ¿é—´</button>
      <button class="filter-tab" data-filter="favorites">â­ æ”¶è—æˆ¿é—´</button>
    </div>

    <div class="row" style="margin-bottom: 16px;">
      <input
        type="text"
        id="playerFilterInput"
        placeholder="æŒ‰ç©å®¶ç­›é€‰ (ä¾‹å¦‚: @fufu)..."
        style="flex: 1; padding: 12px; background: #0b0b0c; border: 1px solid #333; border-radius: 6px; margin-right: 8px;"
      />
      <button id="filterButton" style="padding: 12px 24px; background: #3b82f6; color: white;">ç­›é€‰</button>
      <button id="clearFilterButton" style="padding: 12px 24px; background: #6b7280; color: white; margin-left: 8px;">æ¸…é™¤</button>
    </div>

    <div style="color: #888; font-size: 0.9em; margin-bottom: 16px;">
      <span id="roomCount">åŠ è½½ä¸­...</span>
    </div>

    <div id="roomsList" class="room-grid">
      <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">
        åŠ è½½ä¸­...
      </div>
    </div>

    <div id="pagination" style="margin-top: 20px; text-align: center; display: none;">
      <button id="prevPage" style="margin-right: 8px;" disabled>â† ä¸Šä¸€é¡µ</button>
      <span id="pageInfo" style="color: #888; margin: 0 16px;"></span>
      <button id="nextPage" disabled>ä¸‹ä¸€é¡µ â†’</button>
    </div>
  </div>
</div>

<script type="module">
let currentPage = 1;
let currentFilter = 'all';
let playerFilter = '';
let totalRooms = 0;
let hasNextPage = false;

// Filter tab handling
document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentFilter = tab.dataset.filter;
    currentPage = 1;
    loadRooms();
  });
});

// Player filter handling
document.getElementById('filterButton').addEventListener('click', () => {
  const input = document.getElementById('playerFilterInput').value.trim();
  playerFilter = input.replace('@', ''); // Remove @ prefix if present
  currentPage = 1;
  loadRooms();
});

document.getElementById('clearFilterButton').addEventListener('click', () => {
  document.getElementById('playerFilterInput').value = '';
  playerFilter = '';
  currentPage = 1;
  loadRooms();
});

document.getElementById('playerFilterInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('filterButton').click();
  }
});

// Pagination
document.getElementById('prevPage').addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    loadRooms();
  }
});

document.getElementById('nextPage').addEventListener('click', () => {
  if (hasNextPage) {
    currentPage++;
    loadRooms();
  }
});

async function loadRooms() {
  try {
    const params = new URLSearchParams({
      page: currentPage.toString(),
      limit: '20'
    });

    if (currentFilter === 'favorites') {
      params.set('favorites', 'true');
    }

    if (playerFilter) {
      params.set('player', playerFilter);
    }

    const response = await fetch(`/api/rooms/list?${params}`);
    const result = await response.json();

    if (!result.success) {
      throw new Error(result.error || 'Failed to load rooms');
    }

    totalRooms = result.pagination.total;
    hasNextPage = result.pagination.hasNext;

    // Update count
    let countText = `å…± ${totalRooms} ä¸ªæˆ¿é—´`;
    if (playerFilter) {
      countText += ` (ç©å®¶: @${playerFilter})`;
    }
    if (currentFilter === 'favorites') {
      countText += ' (ä»…æ”¶è—)';
    }
    document.getElementById('roomCount').textContent = countText;

    // Render rooms and get valid count
    const validCount = renderRooms(result.rooms);
    
    // Update count with valid rooms
    if (validCount < result.rooms.length) {
      countText = `å…± ${validCount} ä¸ªæœ‰æ•ˆæˆ¿é—´`;
      if (result.rooms.length - validCount > 0) {
        countText += ` (å·²è¿‡æ»¤ ${result.rooms.length - validCount} ä¸ªæ— æ•ˆæˆ¿é—´)`;
      }
      if (playerFilter) {
        countText += ` Â· ç©å®¶: @${playerFilter}`;
      }
      if (currentFilter === 'favorites') {
        countText += ' Â· ä»…æ”¶è—';
      }
      document.getElementById('roomCount').textContent = countText;
    }

    // Update pagination
    updatePagination();

  } catch (error) {
    console.error('Failed to load rooms:', error);
    document.getElementById('roomsList').innerHTML = `
      <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ef4444;">
        åŠ è½½å¤±è´¥: ${error.message}
      </div>
    `;
  }
}

function renderRooms(rooms) {
  const container = document.getElementById('roomsList');

  // Filter out rooms with invalid data
  const validRooms = rooms.filter(room => {
    // Check for required fields
    if (!room.roomCode) return false;
    if (room.currentRound === undefined || room.currentRound === null) return false;
    if (!room.lastUpdated && !room.createdAt) return false;
    
    // Check for valid date
    const dateStr = room.lastUpdated || room.createdAt;
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return false;
    
    return true;
  });

  if (validRooms.length === 0) {
    container.innerHTML = `
      <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">
        ${playerFilter ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æˆ¿é—´' : 'æš‚æ— æœ‰æ•ˆæˆ¿é—´'}
      </div>
    `;
    return 0;
  }

  container.innerHTML = validRooms.map(room => `
    <div class="room-card ${room.isFavorite ? 'favorite' : ''}" onclick="joinRoom('${room.roomCode}')">
      <div class="room-code">${room.roomCode}</div>

      <div style="margin-bottom: 8px;">
        <span class="status-badge ${room.isFinished ? 'status-finished' : 'status-active'}">
          ${room.isFinished ? 'å·²ç»“æŸ' : 'è¿›è¡Œä¸­'}
        </span>
        <span style="color: #888; font-size: 0.9em; margin-left: 8px;">
          ç¬¬ ${room.currentRound} å±€
        </span>
      </div>

      ${room.teamNames && room.teamNames.length > 0 ? `
        <div class="room-info">
          é˜Ÿä¼: ${room.teamNames.join(' vs ')}
        </div>
      ` : ''}

      <div class="room-info">
        ç©å®¶: ${room.playerCount} äºº
      </div>

      ${room.playerHandles && room.playerHandles.length > 0 ? `
        <div style="margin-top: 8px;">
          ${room.playerHandles.map(handle =>
            `<span class="player-tag">@${handle}</span>`
          ).join('')}
        </div>
      ` : ''}

      <div class="room-info" style="margin-top: 8px;">
        æ›´æ–°: ${formatTime(room.lastUpdated || room.createdAt)}
      </div>
    </div>
  `).join('');
  return validRooms.length;
}

function updatePagination() {
  const paginationDiv = document.getElementById('pagination');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const pageInfo = document.getElementById('pageInfo');

  if (totalRooms === 0) {
    paginationDiv.style.display = 'none';
    return;
  }

  paginationDiv.style.display = 'block';
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = !hasNextPage;
  pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ`;
}

function formatTime(isoString) {
  const date = new Date(isoString);
  const now = new Date();
  const diff = now - date;

  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'åˆšåˆš';
  if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
  if (hours < 24) return `${hours}å°æ—¶å‰`;
  if (days < 7) return `${days}å¤©å‰`;

  return date.toLocaleDateString('zh-CN');
}

// Make joinRoom globally accessible for onclick handlers
window.joinRoom = function(roomCode) {
  // Navigate to main page with room code
  window.location.href = `/?room=${roomCode}`;
};

// Initial load
loadRooms();
</script>
</body>
</html>
